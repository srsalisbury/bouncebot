syntax = "proto3";

option go_package = "github.com/srsalisbury/bouncebot/proto";

package bouncebot;

import "google/protobuf/timestamp.proto";

// Service for client to fetch a game board and return results.
service BounceBot {
  rpc MakeGame (MakeGameRequest) returns (Game) {}
  rpc CheckSolution (CheckSolutionRequest) returns (CheckSolutionResponse) {}

  // Session management
  rpc CreateSession (CreateSessionRequest) returns (Session) {}
  rpc JoinSession (JoinSessionRequest) returns (Session) {}
  rpc GetSession (GetSessionRequest) returns (Session) {}
  rpc StartGame (StartGameRequest) returns (Session) {}
  rpc SubmitSolution (SubmitSolutionRequest) returns (SubmitSolutionResponse) {}
  rpc RetractSolution (RetractSolutionRequest) returns (RetractSolutionResponse) {}
}

// Board grid position.
// This refers to a board position relative to the upper-left board cell.
// For robots, this is the cell the robot sits on.
// For vertical walls, this is the cell to the left of the wall (the wall is to the right).
// For horizontal walls, this is the cell above the wall (the wall below the cell).
message Position {
  int32 x = 1;
  int32 y = 2;
}

message Board {
  // Board is square with size cells horizontally and vertically.
  int32 size = 1;

  // Locations of the vertical walls (edges of board contain implicit walls).
  repeated Position v_walls = 2;

  // Locations of the horizontal walls (edges of board contain implicit walls).
  repeated Position h_walls = 3;
}

message BotPos {
  int32 id = 1;
  Position pos = 2;
}

message Game {
  Board board = 1;
  repeated BotPos bots = 2;
  BotPos target = 3;
}

message MakeGameRequest {
  int32 size = 1;
}

message CheckSolutionRequest {
  Game game = 1;
  repeated BotPos moves = 2;
}

message CheckSolutionResponse {
  bool is_valid = 1;
  int32 num_moves = 2;
  Game resulting_game = 3;
  MoveError first_bad_move = 4; // If solution is not valid
}

message MoveError {
  BotPos move = 1;
  string error_description = 2;
}

// Player in a session
message Player {
  string id = 1;
  string name = 2;
}

// Player's solution result
message PlayerSolution {
  string player_id = 1;
  int32 move_count = 2;
  google.protobuf.Timestamp solved_at = 3;
}

// Game session for multiplayer
message Session {
  string id = 1;
  repeated Player players = 2;
  google.protobuf.Timestamp created_at = 3;
  Game current_game = 4;  // null if no game started yet
  google.protobuf.Timestamp game_started_at = 5;  // when current game started
  repeated PlayerSolution solutions = 6;  // players who have solved the current game
}

message CreateSessionRequest {
  string player_name = 1;
}

message JoinSessionRequest {
  string session_id = 1;
  string player_name = 2;
}

message GetSessionRequest {
  string session_id = 1;
}

message StartGameRequest {
  string session_id = 1;
}

message SubmitSolutionRequest {
  string session_id = 1;
  string player_id = 2;
  int32 move_count = 3;
}

message SubmitSolutionResponse {
  PlayerSolution solution = 1;
}

message RetractSolutionRequest {
  string session_id = 1;
  string player_id = 2;
}

message RetractSolutionResponse {
  bool success = 1;
}

