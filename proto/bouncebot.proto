syntax = "proto3";

option go_package = "github.com/srsalisbury/bouncebot/proto";

package bouncebot;

import "google/protobuf/timestamp.proto";

// Service for client to fetch a game board and return results.
service BounceBot {
  rpc MakeGame (MakeGameRequest) returns (Game) {}

  // Room management
  rpc CreateRoom (CreateRoomRequest) returns (Room) {}
  rpc JoinRoom (JoinRoomRequest) returns (Room) {}
  rpc GetRoom (GetRoomRequest) returns (Room) {}
  rpc StartGame (StartGameRequest) returns (Room) {}
  rpc SubmitSolution (SubmitSolutionRequest) returns (SubmitSolutionResponse) {}
  rpc RetractSolution (RetractSolutionRequest) returns (RetractSolutionResponse) {}
  rpc MarkFinishedSolving (MarkFinishedSolvingRequest) returns (MarkFinishedSolvingResponse) {}
  rpc MarkReadyForNext (MarkReadyForNextRequest) returns (MarkReadyForNextResponse) {}
}

// Board grid position.
// This refers to a board position relative to the upper-left board cell.
// For robots, this is the cell the robot sits on.
// For vertical walls, this is the cell to the left of the wall (the wall is to the right).
// For horizontal walls, this is the cell above the wall (the wall below the cell).
message Position {
  int32 x = 1;
  int32 y = 2;
}

message Board {
  // Board is square with size cells horizontally and vertically.
  int32 size = 1;

  // Locations of the vertical walls (edges of board contain implicit walls).
  repeated Position v_walls = 2;

  // Locations of the horizontal walls (edges of board contain implicit walls).
  repeated Position h_walls = 3;
}

message BotPos {
  int32 id = 1;
  Position pos = 2;
}

message Game {
  Board board = 1;
  repeated BotPos bots = 2;
  BotPos target = 3;
}

message MakeGameRequest {
  int32 size = 1;
}

// Player in a room
message Player {
  string id = 1;
  string name = 2;
}

// Player's solution result
message PlayerSolution {
  string player_id = 1;
  google.protobuf.Timestamp solved_at = 2;
  repeated BotPos moves = 3;
}

// Player's cumulative score in the room
message PlayerScore {
  string player_id = 1;
  int32 wins = 2;  // number of games won
}

// Game room for multiplayer
message Room {
  string id = 1;
  repeated Player players = 2;
  google.protobuf.Timestamp created_at = 3;
  Game current_game = 4;  // null if no game started yet
  google.protobuf.Timestamp game_started_at = 5;  // when current game started
  repeated PlayerSolution solutions = 6;  // players who have solved the current game
  repeated PlayerScore scores = 7;  // cumulative scores across games
  int32 games_played = 8;  // total games completed in room
  repeated string finished_solving = 9;  // player IDs who are finished solving (triggers game end)
  repeated string ready_for_next = 10;  // player IDs who are ready for next game
}

message CreateRoomRequest {
  string player_name = 1;
}

message JoinRoomRequest {
  string room_id = 1;
  string player_name = 2;
}

message GetRoomRequest {
  string room_id = 1;
}

message StartGameRequest {
  string room_id = 1;
  bool use_fixed_board = 2;  // If true, use Game1() instead of random
}

message SubmitSolutionRequest {
  string room_id = 1;
  string player_id = 2;
  repeated BotPos moves = 3;
}

message SubmitSolutionResponse {
  PlayerSolution solution = 1;
}

message RetractSolutionRequest {
  string room_id = 1;
  string player_id = 2;
}

message RetractSolutionResponse {
  bool success = 1;
}

message MarkFinishedSolvingRequest {
  string room_id = 1;
  string player_id = 2;
}

message MarkFinishedSolvingResponse {
  bool success = 1;
}

message MarkReadyForNextRequest {
  string room_id = 1;
  string player_id = 2;
}

message MarkReadyForNextResponse {
  bool success = 1;
}
